---
title: "Discord Slash CommandのInteractionをAzure Functionsにデプロイしてみる"
emoji: "⚡"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["azure", "discord", "typescript", "serverless", "azurefunctions"]
published: false
---

# はじめに

## TL;DR

Discord の Slash Command を TypeScript を使って開発し、
Azure Functions にデプロイすることで簡単なボットのようなアプリをサーバーレスに作ることできる。

## 扱う内容・対象読者

この記事では、Azure Functions にデプロイした関数を
Discord Slash Command の Interaction Endpoint に指定して使うまでを目標とします。

したがって次のような項目を扱います。

- Slash Command の概要と作成方法
- Azure Function アプリを TypeScript で開発しデプロイする方法
- Slash Command の Interaction を扱う方法

想定している読者層としては次のような感じです。

- GitHub を使っている
- Discord を使っていて Bot を作ってみたい/作ったことがある
- TypeScript がある程度わかる
- Azure アカウントを持っていて、何かサービスを作ってみたい

ただし難易度は低いので、興味さえあればこの限りではございません。

## 環境について

今回自分が使用した環境を次に示します。

|項目|環境|
|:---:|:---:|
|エディタ|VSCode|
|Node.js|v14.16.1|
|OS|Windows 10 Home|

また、VSCode で開発する際に「[Azure Functions](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions)」という
Microsoft が出している拡張機能を入れているので、そちらも導入しておくことをお勧めします。

# Discord Slash Commandを作成する

## Slash Commandとは

そもそも Slash Command とはいったいなんでしょうか。
従来から Discord では API を使うことによって Bot を作る仕組みがあり、Python や JavaScript で実装された便利なライブラリを使うことによって簡単に作成できます。
Bot を作ることによってユーザのメッセージなどにリアルタイムで応答するような仕組みを実装できましたが、それにはソケット通信を常に行っているサーバーから実装しなくてはいけなかったため、いくつも Bot を作るのはちょっと面倒でした。
自分は Python で作った Bot を Heroku にデプロイして使っていましたが、Heroku の無料枠では 5 つまでしかアプリをデプロイできないため、シンプルなボットを作るには正直コスパが悪かったです。

Slash Command は、Bot のようなユーザとインタラクションできるアプリケーションを作る新しい仕組みです。

@[youtube](4XxcpBxSCiU)

Slash Command を使うことにより、開発者はユーザのメッセージを Webhook 的に受け取ることができたり、ユーザはコマンド名や引数のオートコンプリートを利用できるようになりました。

Slash コマンドはアプリケーションを招待した全てのサーバーおよび DM で使える Global Command と、特定のサーバーのみで使える Guild Command の 2 種類あります。
Global Command は登録してから反映されるまで 1 時間かかったりするらしいので、今回は Guild Command を作る予定です。

## Applicationの作成

まずは [Discord Developer Portal](https://discord.com/developers/applications/) にアクセスして Slash Command を使用するためのアプリケーションを作成します。
「New Application」ボタンをクリックすると名前を入力する必要があります。
「zenn-slash-tutorial」という名前で作ってみました。
![img](https://storage.googleapis.com/zenn-user-upload/c0beaa498bc6bcada402e8e9.png)
アプリケーションのページに移動すると、General Information、OAuth2、といった下に「Bot」というタブがあるのでそこへ移動し、ボットを作成しましょう。

ボットが作成出来たら OAuth2 タブに移動して権限を付与しましょう。
Slash Command を使うためには「application.command」にチェックを入れる必要があります。
![img](https://storage.googleapis.com/zenn-user-upload/1d7537e4c6d8c052657f1254.png)
その時に表示される URL へ移動し、Slash Command を使うためのサーバーへ招待しましょう。無事招待できたらサーバー設定から「連携サービス」の項目にアプリケーションがあるはずですのでご確認ください。
![img](https://storage.googleapis.com/zenn-user-upload/554d784db04e77632fc8571c.png)

## Slash Commandの登録

Slash Command はアプリケーションに登録することで使うことができます。
コマンドを登録するためには discrod の API エンドポイントに POST リクエストを送る必要があり、まずはそのプログラムを実行していきましょう。
公式に Web クライアントとかできてくれると嬉しいんだけどな......。

Slash Command の作成には、次の記事を参考にさせていただきました。

https://zenn.dev/tubuan/articles/discordjs-slash-commands

Slash Command 登録のためのディレクトリを作成し、
そのディレクトリで次のコマンドを実行します。

```bash
# initialize node.js project
$ yarn init -y

# install node-fetch & request
# もしかしたらrequestいらないかもしれない
$ yarn add node-fetch request
```

プロジェクトの中に`index.js`を作成し、次のように編集します。

```js: index.js
const appID = "<application id>";
const guildID = "<guild id>"
const apiEndpoint = 
  `https://discord.com/api/v8/applications/${appID}/guilds/${guildID}/commands`;
const botToken = "<bot tolen>";

const commandData = {
  name: "zenntest",
  description: "command for zenn tutorial",
  options: [
    {
      name: "say",
      description: "say something",
      type: 3,
      required: true,
      choices: []
        {
          name: "Hello",
          value: "hello"
        },
        {
          name: "Goodbye",
          value: "goodbye"
        },
        {
          name: "hoge hoge",
          value: "hoge"
        },
      ],
    },
  ],
};

async function main() {
    const fetch = require("node-fetch");

  const response = await fetch(apiEndpoint, {
    method: "post",
    body: JSON.stringify(commandData),
    headers: {
      Authorization: "Bot " + botToken,
      "Content-Type": "application/json",
    },
  });
  const json = await response.json();

  console.log(json);
}
main();
```

Slash Command の登録には次のような情報が必要ですので、Discord の Developer Portal やサーバー設定を適宜参照してください。

|変数名|説明|
|:--:|:--:|
|`appID`|コマンドを登録するアプリケーション ID|
|`guildID`|実際にコマンドを使用するサーバーの ID|
|`botToken`|アプリケーションで有効になっている Bot のトークン|

`main()`関数の中では`commandData`オブジェクトを Discord API に POST する処理が書かれている感じでです。
`commandData`の中身を見てみましょう。

```js
const commandData = {
  name: "zenntest",
  description: "command for zenn tutorial",
  options: [
    {
      name: "say",
      description: "say something",
      type: 3,
      required: true,
      choices: []
        {
          name: "Hello",
          value: "hello"
        },
        {
          name: "Goodbye",
          value: "goodbye"
        },
        {
          name: "hoge hoge",
          value: "hoge"
        },
      ],
    },
  ],
};
```

このオブジェクトの説明をサクッとまとめるとこんな感じになります。

|プロパティ|説明|実際の動作|
|:--:|:--:|:--:|
|name|コマンド名|`/zenntest`というコマンドを使うことになります|
|description|コマンドの説明|コマンドを打つときに表示されます|
|options|コマンドの引数。省略可能|今回は 1 つの引数をとるコマンドになります|
|options.name|引数の名前です|say という名前の引数を指定します|
|options.type|引数の型です|string 型を示す 3 にしています^[https://discord.com/developers/docs/interactions/slash-commands#application-command-object-application-command-option-type]|
|options.required|必須な引数か|今回は必要としています|
|options.choices|選択肢|Hello, Goodbye, hogehoge がオートコンプリートされます|

ここまでできたら、`node index.js`として実行します。
無事に登録で来たら、コマンドの情報がログ出力されるでしょう。
もし同じコマンド名でこのプログラムを実行した場合には、最後に実行した内容で上書きされます。

実際にスラッシュコマンドを使って見ると、入力内容がちゃんと補完されていることがわかるはずです。
現時点ではまだコマンドの動作を定義していないので、コマンドを使ってもエラーになってしまいます。

![img](https://storage.googleapis.com/zenn-user-upload/85943aca2d617c36a268a364.png)


# Interaction の開発

## Interaction^[https://discord.com/developers/docs/interactions/slash-commands#receiving-an-interaction]とは

コマンドが登録されたアプリケーションは、ユーザから Slash Command が発行されると
受け取った情報を登録された URL に POST します。
この POST された情報のことを「Interaction」と呼び、Interaction を POST され、
適切なレスポンスを返すサーバーの URL を Interaction Endpoint としてアプリケーションに登録します。

前述したように従来の Discord Bot では常時ソケット通信用のコネクションを張ったサーバーアプリケーションが必要でしたが、
Slash Command の場合は webhook 的に動作するサーバーレス関数でも十分に対応できます。

## TypeScriptプロジェクトの作成

Slash Command の Interaction を処理するために、TypeScript のプロジェクトを作成していきます。
このプロジェクトは Azure Functions にデプロイする前提で作っていくため、VSCode の Azure Functions 拡張機能を用いてプロジェクトのひな型を作ります。

Interaction Endpoint プロジェクトのためのディレクトリを切って VSCode で開き、Azure タブからプロジェクトの初期化をしていきましょう。

![img](/images/slash-azure-functions/create-functions.png)

VSCode の案内に従えばプロジェクトのテンプレートが作成されます。
プロジェクトは次の仕様で作成した前提のもと進めていきます。

|環境|内容|
|:-:|:-:|
|言語|TypeScript|
|トリガー|HttpTrigger|
|ランタイムスタック|Node.js v14|

まずはプロジェクトで必要な npm モジュールをインストールしていきましょう。

```bash
# install & add dependency
$ npm install
$ npm install discord-interactions express @types/node
```

:::message
`express`は今回使いませんが、`discord-interactions`の依存に含まれているためインストールしないとTypeScriptのコンパイルに失敗するようです。
:::

:::message alert
`discord-interactions`と`discord-interaction`というnpmパッケージが存在します。今回は前者の複数形の方を使うので、くれぐれも間違えないようにしてください......。

@[tweet](https://twitter.com/ninisan_drumath/status/1417907332520939523)
:::

## Interactionを処理するプログラム

Interaction を扱うため、次のような処理をするプログラムを作成します。

1. POST で Interaction を受け取る
2. ヘッダーの署名を検証する
3. 不正な署名だったら 401 を返す
4. Interaction の type が 4 だったら Content を添えてレスポンス
5. type が 1 だったら PONG を返す

# Azure Functionsへデプロイ

## Azure Functionsプロジェクトの作成

## Azure Portalでの作業・管理

# おわりに

## まとめ

## 参考