---
title: "WebXRでカメラ情報を取得できるRaw Camera Accessについての調査録"
emoji: "📸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["webar", "babylonjs", "webgl", "typescript", "ar"]
published: false
---

# はじめに

## TL;DR

## 概要

この記事は[WebXR アドベントカレンダー]()の〇日目の記事です。

私は WebAR を使った開発をすることがあるのですが、
その中で「カメラの情報を取得したい」という課題を抱えており、
色々調べて発見した謎の WebXR Raw Camera Access Feature について紹介していきます。

## 扱う内容

本記事では以下のような内容を扱います。

- WebXR Raw Camera Access API の概要
- Raw Camera Access API の現状
- Babylon.js を使った使用方法

また、今回の記事では技術スタックの基本事項を確認せずに使用する場合があります。
したがって基本的な Web フロントエンドの知識や 3DCG の知識、TypeScript の文法などを
理解していることが望ましいです。

## 対象読者

以下に示すような方には、本記事で触れる内容が役に立つと考えます。

- WebAR でカメラ画像を取得したい人
- WebXR Device API で何ができるのかを知りたい人

また詳細は後述しますが、今回扱う API は**かなり最近出てきた実験的な API**です。
試すときは自己責任でお願いします。
そして 2021 ねん 1 月現在、この API が使えるのは Chrome for Android のみと発表されているので、
iOS で WebXR をやられている方はごめんなさい。

## 想定環境

筆者が用いた環境を以下に示します。

- 開発機：Windows 10 Home
- デバッグ機：Pixel 4a 5G（Android12）, Nexus 5X（Android8.1）
- Node.js 16.x
- Babylon.js **5.0.0.preview-60**
- TypeScript
- Vite 2

# Raw Camera Access の現状調査

## Raw Camera Access とはいったい何か

WebXR Raw Camera Access Feature とは、その名の通り
WebXR Device API 経由でカメラ画像テクスチャを取得し、
それを WebAR アプリケーションで利用するための機能です。

https://chromestatus.com/feature/5759984304390144

なんだか普通に実装されてそうな機能ですが、
実はセキュリティの観点から長らく実装されていませんでした。
代替として getUserMedia が考えられますが、
普通にスマホでやってしまうと getUserMedia と WebXR Device API がカメラのストリームを奪い合ってしまうため
厳しい選択です。

上に載せた Chrome Platform Status の Platform Support Explanation の一部を引用します。

> This will be supported on platforms where Chrome supports AR. Currently, this is only Android. WebView support is planned. There are no technical restrictions specific to this API preventing it from being implemented on other platforms.

これによると、Raw Camera Access Feature は
AR がサポートされている Chrome でサポートされる予定であり、
現在(2021/11/27)時点では Chrome for Android のみとのことです。

## API の情報整理と利用可能性

もともと Raw Camera Access は次の GitHub に提案内容がありました。
最終コミットが 2021 年の 6 月なので、Raw Camera Access が実験的にリリースされる前ですね。

https://github.com/immersive-web/raw-camera-access/blob/main/explainer.md

この提案内容の中には、すでに Raw Camera Access を有効にする方法や、
それを使ってカメラ画像とカメラ内部パラメータを計算・取得する方法が記載されています。
具体的に内容を抜粋してみます。

まず Raw Camera Access を有効にするためには、
XRSession を取得する際に feature として`"camera-access"`を require します。

```js:GitHubより抜粋
const session = await navigator.xr.requestSession("immersive-ar", {
  requiredFeatures: ["camera-access"]
});
```

そしてカメラ画像を取得するためのサンプルコードは次のようになっていました。

```js:GitHubより抜粋（ちょっと改変）
// ... in rAFcb ...
let viewerPose = xrFrame.getViewerPose(xrRefSpace);
for (const view of viewerPose.views) {
  if (view.camera) {
    const cameraTexture = binding.getCameraImage(view.camera);
  }
}
```

最終的に`cameraTexture`に格納されたものがカメラのテクスチャとなります。
このテクスチャは`WebGLTexture`オブジェクトで、WebGL API で扱うことができる画像データです。

またコメントでも記載されている通り、このコードは
`xrSession.requestAnimationFrame`コールバック内で実行される必要があります。
このコールバックは通常の Web API の requestAnimationFrame とは異なり、WebXR 専用のものですので注意が必要です。

このコード中に存在する`view.camera`や`binding.getCameraImage`などは
通常型宣言には組まれていないため、TypeScript で扱う場合や型補完を効かせたい場合には
型宣言をする必要があります。その例を次に抜粋します。

```ts:GitHubより抜粋
partial interface XRView {
  // Non-null iff there exists an associated camera that perfectly aligns with the view:
  [SameObject] readonly attribute XRCamera? camera;
};

interface XRCamera {
  // Dimensions of the camera image:
  readonly attribute long width;
  readonly attribute long height;
};

partial interface XRWebGLBinding {
  // Access to the camera texture itself:
  WebGLTexture? getCameraImage(XRCamera camera);
};
```

<!-- intrinsicsのサンプルをこちらに -->

## Babylon.jsでの利用

<!-- サンプルまでは用意できなかったが -->
<!-- Babylon.jsでどんな感じで使えるのかをさらっと書く -->

## 使用時の注意

<!-- WebXR Incubationを有効に仕様ねってこと -->


# おわりに

## 参考文献
